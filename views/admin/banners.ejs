<%- include('../layouts/header.ejs')%>
<style>
  /* Assuming .bg-glass class has some custom styling */
.bg-glass {
  background-color: rgba(255, 255, 255, 0.2); /* Example background color with opacity */
  /* Add any other styles you want for the bg-glass class */
}

/* Bootstrap classes for form-control-file */
.form-control-file {
  display: block;
  width: 100%;
  height: calc(1.5em + 0.75rem + 2px);
  padding: 0.375rem 0.75rem;
  font-size: 1rem;
  line-height: 1.5;
  color: #495057;
  background-color: #fff;
  background-clip: padding-box;
  border: 1px solid #ced4da;
  border-radius: 0.25rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}



</style>


  <body class="g-sidenav-show bg-gray-200 ">
    <!-- aside -->
    <aside
      class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3   bg-gradient-dark"
      id="sidenav-main">
      <div class="sidenav-header">
        <i class="fas fa-times p-3 cursor-pointer text-white opacity-5 position-absolute end-0 top-0 d-none d-xl-none"
          aria-hidden="true" id="iconSidenav"></i>
         <a class="navbar-brand m-0" 
          target="_blank">
          <img src="/img/favicon.png" class="navbar-brand-img h-100" alt="main_logo">
          <span class="ms-1 font-weight-bold text-white">Thrift Kicks</span>
        </a>
      </div>
      <hr class="horizontal light mt-0 mb-2">
      <div class="collapse navbar-collapse  w-auto " id="sidenav-collapse-main">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link text-white " href="/admin/dashboard">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
               <i class="fa-solid fa-store"></i>
              </div>
              <span class="nav-link-text ms-1">Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="/admin/salesReport">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
              <i class="fa-solid fa-file"></i>
              </div>
              <span class="nav-link-text ms-1">Sales Report</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white " href="/admin/users">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                  <i class="fa fa-users" aria-hidden="true"></i>
              </div>
              <span class="nav-link-text ms-1">Users</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white " href="/admin/orders">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="material-icons opacity-10">receipt_long</i>
              </div>
              <span class="nav-link-text ms-1">Orders</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="/admin/products">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="material-icons opacity-10">view_in_ar</i>
              </div>
              <span class="nav-link-text ms-1">Products</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="/admin/categories">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
               <i class="fa-solid fa-list"></i>
              </div>
              <span class="nav-link-text ms-1">Categories</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="/admin/coupons">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="fa-solid fa-ticket"></i>
              </div>
              <span class="nav-link-text ms-1">Coupons</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white active bg-gradient-secondary" href="/admin/banners">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="fa-solid fa-newspaper"></i>
              </div>
              <span class="nav-link-text ms-1">Banners</span>
            </a>
          </li> 
          <li class="nav-item">
            <a class="nav-link text-white" href="/admin/offers">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="fa-solid fa-percent"></i>
              </div>
              <span class="nav-link-text ms-1">Offers</span>
            </a>
          </li>
          <hr class="horizontal light mt-0 mb-2">

          <li class="nav-item">
            <a class="nav-link text-white " href="/admin/logout">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="material-icons opacity-10">assignment</i>
              </div>
              <span class="nav-link-text ms-1">Logout</span>
            </a>
          </li>
        </ul>
      </div>

    </aside>
    <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">
      <div class="mt-n3">
        <!-- Navbar -->
        <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur"
          data-scroll="true">
          <div class="container-fluid py-1 px-3">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
                <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Pages</a></li>
                <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Banners</li>
              </ol>
              <h6 class="font-weight-bolder mb-0">Banners</h6>
            </nav>
            <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
              <div class="ms-md-auto pe-md-3 d-flex align-items-center">

              </div>
              <ul class="navbar-nav  justify-content-end">

                <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
                  <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
                    <div class="sidenav-toggler-inner">
                      <i class="sidenav-toggler-line"></i>
                      <i class="sidenav-toggler-line"></i>
                      <i class="sidenav-toggler-line"></i>
                    </div>
                  </a>
                </li>
                <li class="nav-item px-3 d-flex align-items-center">
                  <a href="javascript:;" class="nav-link text-body p-0">
                    <i class="fa fa-cog fixed-plugin-button-nav cursor-pointer"></i>
                  </a>
                </li>
                <li class="nav-item dropdown pe-2 d-flex align-items-center">
                  <a href="javascript:;" class="nav-link text-body p-0" id="dropdownMenuButton"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa fa-bell cursor-pointer"></i>
                  </a>
                  <ul class="dropdown-menu  dropdown-menu-end  px-2 py-3 me-sm-n4" aria-labelledby="dropdownMenuButton">


                  </ul>
                </li>
                <li class="nav-item d-flex align-items-center">
                  <a href="../pages/sign-in.html" class="nav-link text-body font-weight-bold px-0">
                    <i class="fa fa-user me-sm-1"></i>
                    <span class="d-sm-inline d-none">Sign In</span>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </nav>
        <!-- End Navbar -->
      </div>
      <div class="container-fluid py-4">
        <div class="row">
          <div class="col-12">
            <div class=" my-4">
              <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                <div class="bg-gradient-secondary shadow-dark border-radius-lg pt-4 pb-3">
                  <h6 class="text-white text-capitalize ps-3">Banners</h6>
                </div>

                <button id="addBannerBtn" class="btn btn-outline-info btn-lg my-4">Add New
                    Banner</button>

              </div>

              <div class="border-radius-xl mx-2 mx-md-3 position-relative"
                style="background-image: url('..asssets/img/bg-pricing.jpg'); background-size: cover;">
    </div>

    <div class="container">
      <div class="row">
        <div class="col-12">

          
          <table class="table table-striped">
            <thead class="thead-light">
              <tr>
                <th scope="col">Title</th>
                <th scope="col">Banner</th>
                <th scope="col">Description</th>
                <th scope="col">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Status</th>
              </tr>
            </thead>
            <tbody>
              <% if (typeof banner !== 'undefined' && banner.length > 0 ){   %>
                <% banner.reverse() %>
               <% banner.forEach((banner,index)=>{  %>
                  <tr>
                  
                    <td class="p-4" style="width:280px;"><%= banner.title %></td>
                    <td class="p-2" style="width:300px;"><img class="images" src="<%= banner.imageUrl %>" alt="Banner Img" style="height:150px; width:220px; cursor:pointer;"></td>
                    <td class="p-4" style="text-wrap: wrap;"><%= banner.description %></td>
                    <td class="p-4">
                      
                      <button data-banner-id="<%= banner._id %>"
                        data-state="<% if(banner.is_listed === true){%>listed<%} else {%>unlisted<%} %>"
                        class="btn unlistButton custom-button
                      <%  if(banner.is_listed === true){%> btn-danger <% } else { %> btn-success <% } %> mx-3 
                      ">
                        <% if(banner.is_listed===true){%> Unlist <% } else { %> List <% } %>
                      </button>
                      <button class="btn btn-dark bannerDelBtn" data-banner-id="<%= banner._id %>">
                        Delete
                      </button>

                    </td>
                  </tr>
             <%   })  %> 
            
           <% }  %>
            </tbody>
          </table>


        </div>
      </div>
    </div>
    
   

 

    <script>
  
  const addBannerBtn = document.getElementById('addBannerBtn')
  addBannerBtn.addEventListener('click', async () => {
  const { value: formValues } = await Swal.fire({
    title: 'Add Banner',
    html: `
      <form enctype="multipart/form-data">
        <div class="form-group">
          <label class="text-lg" for="image">Select Banner Image</label>
          <input type="file" id="image" accept="image/*" class="form-control-file  bg-glass">
        </div>
        <div class="form-group">
          <label class="text-lg" for="title">Title</label>
          <input type="text" id="title" class="form-control bg-glass">
        </div>
        <div class="form-group">
          <label class="text-lg" for="description">Description</label>
          <input type="text" id="description" class="form-control bg-glass">
        </div>
        <div class="form-group">
          <label class="text-lg" for="link">Link</label>
          <input type="text" id="link" class="form-control bg-glass">
        </div>
      </form>
      
    `,
    focusConfirm: false,
    showCancelButton: true,
    confirmButtonText: 'Add Banner',
    // showConfirmButton : false,
    cancelButtonText: 'Cancel',
    cancelButtonColor: '#DC3545',
    preConfirm: async () => {
      const image = document.getElementById('image').files[0];
    
      // const compressedImage = await imageCompression(imageFile, {
      //   maxSizeMB: 1, // Adjust the maximum size
      // });
      const titleValue = document.getElementById('title').value;
      const descrValue = document.getElementById('description').value;
      const link = document.getElementById('link').value;


      const formData = new FormData();
      formData.append('image', image);
      formData.append('titleValue', titleValue);
      formData.append('descrValue', descrValue);
      formData.append('link', link);
    
      if(image === null || image === undefined){
        const Toast = Swal.mixin({
        toast: true,
        position: "center",
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: false,
        didOpen: (toast) => {
          toast.onmouseenter = Swal.stopTimer;
          toast.onmouseleave = Swal.resumeTimer;
        }
      });
      Toast.fire({
        icon: "danger",
        title: "Add a Banner image"
      });
      return
      }

      if(titleValue === ""){
        const Toast = Swal.mixin({
        toast: true,
        position: "center",
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: false,
        didOpen: (toast) => {
          toast.onmouseenter = Swal.stopTimer;
          toast.onmouseleave = Swal.resumeTimer;
        }
      });
      Toast.fire({
        icon: "danger",
        title: "Add a Banner title"
      });
      return
      }

      if(descrValue === "" ){
        const Toast = Swal.mixin({
        toast: true,
        position: "center",
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: false,
        didOpen: (toast) => {
          toast.onmouseenter = Swal.stopTimer;
          toast.onmouseleave = Swal.resumeTimer;
        }
      });
      Toast.fire({
        icon: "danger",
        title: "Add a Banner description"
      });
      return
      }


      if(link === "" ){
        const Toast = Swal.mixin({
        toast: true,
        position: "center",
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: false,
        didOpen: (toast) => {
          toast.onmouseenter = Swal.stopTimer;
          toast.onmouseleave = Swal.resumeTimer;
        }
      });
      Toast.fire({
        icon: "danger",
        title: "Add a Banner link"
      });
      return
      }

      const response = await fetch('/admin/add-banner',{
            method: "POST",
            body: formData,
          })

          const data = await response.json();
            if(data.success){
              
            }
      return {
        image: document.getElementById('image').files[0],
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        link: document.getElementById('link').value,
      };
    },
    
  });

  if (formValues && formValues.image) {
    const reader = new FileReader();
    reader.onload = (e) => {
      Swal.fire({
        title: 'Banner Preview',
        html: `
          <div class="card" style="width: 18rem;">
            <div class="card-body">
              <h5 class="card-title">${formValues.title}</h5>
              <p class="card-text">${formValues.description}</p>
            </div>
          </div>
        `,
        imageUrl: e.target.result,
        imageAlt: 'The uploaded picture',
        showCancelButton: false,
        confirmButtonText: 'Ok',
        confirmButtonColor: '#007BFF',
        cancelButtonText: 'Cancel',
        cancelButtonColor: '#DC3545',
      }).then((result) => {
    if (result.isConfirmed) {
      
      location.reload()
      
    }})


    };
    reader.readAsDataURL(formValues.image);
  }
});

//for loading image
const images = document.querySelectorAll('.images').forEach((img)=>[
  img.addEventListener('click',()=>{
    
    const imageUrl = img.src;

    // Show the clicked image in SweetAlert modal
    Swal.fire({
      imageUrl: imageUrl,
      imageAlt: 'Clicked Image',
      confirmButtonText: 'Close',
    });
  })

])


//list unlist banner
document.querySelectorAll(".unlistButton").forEach(function (button) {
        button.addEventListener("click", listUnlistBanner)
      })

      async function listUnlistBanner() {
        const bannerId = this.getAttribute("data-banner-id");
        const currentState = this.getAttribute("data-state");
        let url;
        if (currentState === "listed") {
          url = `/admin/unlistBanner`;
        } else {
          url = `/admin/listBanner`;
        }
        const response = await fetch(url, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
          },
          body:JSON.stringify({bannerId})
        })
        if (!response.ok) {
          throw new Error("Failed to fetch data");
        }
        const data = await response.json()

        if (currentState === "listed") {
          this.textContent = "List";
          this.setAttribute("data-state", "unlisted");
          this.classList.remove("btn-danger");
          this.classList.add("btn-success");

          const Toast = Swal.mixin({
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                  toast.onmouseenter = Swal.stopTimer;
                  toast.onmouseleave = Swal.resumeTimer;
                }
              });
              Toast.fire({
                icon: "error",
                title: "Banner Unlisted"
              });

        } else {
          this.textContent = "Unlist";
          this.setAttribute("data-state", "listed");
          this.classList.remove("btn-success");
          this.classList.add("btn-danger");

          const Toast = Swal.mixin({
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                  toast.onmouseenter = Swal.stopTimer;
                  toast.onmouseleave = Swal.resumeTimer;
                }
              });
              Toast.fire({
                icon: "success",
                title: "Banner Listed"
              });
        }
      }


      //Banner delete
      const bannerDelBtn = document.querySelectorAll('.bannerDelBtn')
      bannerDelBtn.forEach((btn)=>{
        btn.addEventListener('click',deleteBannerFn)
      })

      async function deleteBannerFn(){
        try {
          const bannerId = this.getAttribute("data-banner-id")

          Swal.fire({
          title: "Are you sure?",
          text: "You won't be able to revert this!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Yes, delete it!"
        }).then(async (result) => {
          if (result.isConfirmed) {

            const response = await fetch('/admin/deleteBanner',{
            method:'DELETE',
            headers:{
              'Content-Type':'application/json',
            },
            body: JSON.stringify({bannerId})
          })

          const data = await response.json()
          if(data.message){

            this.parentNode.parentNode.remove()
            Swal.fire({
                          title: "Deleted!",
                          text: "Banner has been deleted.",
                          icon: "success"
                        });
          }            
          }
        });

          
        } catch (error) {
          console.log("Was unable to delete banner");
        }
      }


    </script>

    <%- include('../layouts/footer.ejs')%>