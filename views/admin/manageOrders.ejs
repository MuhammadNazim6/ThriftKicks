<%- include('../layouts/header.ejs')%>

<div class="mt-n3">
  <!-- Navbar -->
  <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur" data-scroll="true">
    <div class="container-fluid py-1 px-3">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
          <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Pages</a></li>
          <li class="breadcrumb-item text-sm text-dark active" aria-current="page"><a class="text-dark" href="/admin/products">Orders</a></li>
          <li class="breadcrumb-item text-sm text-dark active" aria-current="addProduct">Manage-Orders</li>
        </ol>
      </nav>
      <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
        <div class="ms-md-auto pe-md-3 d-flex align-items-center">
         
        </div>
        <ul class="navbar-nav  justify-content-end">
         
          <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
            <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
              <div class="sidenav-toggler-inner">
                <i class="sidenav-toggler-line"></i>
                <i class="sidenav-toggler-line"></i>
                <i class="sidenav-toggler-line"></i>
              </div>
            </a>
          </li>
          <li class="nav-item px-3 d-flex align-items-center">
            <a href="javascript:;" class="nav-link text-body p-0">
              <i class="fa fa-cog fixed-plugin-button-nav cursor-pointer"></i>
            </a>
          </li>
          <li class="nav-item dropdown pe-2 d-flex align-items-center">
            <a href="javascript:;" class="nav-link text-body p-0" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fa fa-bell cursor-pointer"></i>
            </a>
            <ul class="dropdown-menu  dropdown-menu-end  px-2 py-3 me-sm-n4" aria-labelledby="dropdownMenuButton">
              
              
              
            </ul>
          </li>
          <li class="nav-item d-flex align-items-center">
            <a href="../pages/sign-in.html" class="nav-link text-body font-weight-bold px-0">
              <i class="fa fa-user me-sm-1"></i>
              <span class="d-sm-inline d-none">Sign In</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <!-- End Navbar -->
</div>


<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card my-4">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
          <div class="bg-gradient-primary shadow-primary border-radius-lg pt-4 pb-3">
            <h5 class="text-white text-capitalize ps-3">Manage-Orders</h5 >
          </div>
        </div>


        <div class="container mt-5">
          <form action="" method="post">


            <div class="tab-pane">
              <div class="card-body pb-2" style="display: flex;">
            
                  <div class="left-side" style="flex: 1;">
                      <div class="form-group">
                          <label class="form-label text-lg">Order Id</label>
                          <input type="text" id="orderId" class="form-control text-lg bg-glass text-bold pl-4" value="<%= currentOrder._id %>" style="width: 380px;" readonly>
                      </div>
          
                      <div class="form-group">
                          <label class="form-label text-lg">Order Status</label>

                       <% if(currentOrder.OrderStatus !== "Cancelled"){ %>
                      
                          <select class="form-control text-lg bg-glass pl-4" id="orderStatus" style="width: 380px;" value="<%= currentOrder.OrderStatus %>">
                              <option value="<%= currentOrder.OrderStatus %>"><%= currentOrder.OrderStatus %></option>
                              <option value="Pending" style ="<%= currentOrder.OrderStatus === 'Pending' ? 'display:none;' : '' %>">Pending </option>
                              <option value="Shipped"  style ="<%= currentOrder.OrderStatus === 'Shipped' ? 'display:none;' : '' %>">Shipped</option>
                              <option value="Out for Delivery"  style="<%= currentOrder.OrderStatus === 'Out for Delivery' ? 'display:none;' : '' %>">Out for Delivery</option>
                              <option value="Delivered"  style="<%= currentOrder.OrderStatus === 'Delivered' ? 'display:none;' : '' %>">Delivered</option>
                          </select>
                          <% }else{ %>
                            <input id="cancelledInput" type="text" class="form-control text-lg bg-danger pl-4 text-white" value="Cancelled" style="width:140px" readonly>
                            <%  }  %>

                          <input id="cancelledInput" type="text" class="form-control text-lg bg-danger pl-4 text-white" value="Cancelled" style="display:none; width:140px" readonly>
                      </div>
                      <% if(currentOrder.OrderStatus !== "Cancelled"){ %>
                          <button class="btn btn-info mt-2" id="changeStatusBtn" type="button" > Change Status</button>
                          <div class="mt-4"> <button class="btn btn-danger" id="CancelOrder" type="button" > Cancel Order</button></div>
                      <% } %>
                        </div>
          
          
                  <div class="center" style="flex: 1;">
                      <div class="form-group" style="width: 380px;">
                          <label class="form-label text-lg">Shipping Address</label>
                          <input type="text" class="form-control text-lg bg-glass pl-4 addressCell" value="<%= currentOrder.shippingAddress.fullName %>" readonly>
                          <input type="text" class="form-control text-lg bg-glass pl-4 addressCell" value="<%= currentOrder.shippingAddress.mobile %>" readonly>
                          <input type="text" class="form-control text-lg bg-glass pl-4 addressCell" value="<%= currentOrder.shippingAddress.city %>" readonly>
                          <input type="text" class="form-control text-lg bg-glass pl-4 addressCell" value="<%= currentOrder.shippingAddress.pincode %>" readonly>
                          <input type="text" class="form-control text-lg bg-glass pl-4 addressCell" value="<%= currentOrder.shippingAddress.state %>" readonly>
                          <input type="text" class="form-control text-lg bg-glass pl-4 addressCell" value="<%= currentOrder.shippingAddress.country %>" readonly>
                      </div>
                  </div>
          
                  
                  <div class="right-side" style="flex: 1;">
                      <div class="form-group">
                          <label class="form-label text-lg">Order Date</label>
                          <input type="text" class="form-control text-lg bg-glass pl-4" value="<%= currentOrder.orderDate %>" style="width:160px;" readonly>
                      </div>
          

          
                      <div class="form-group">
                          <label class="form-label text-lg">Payment Method</label>
                          <input type="text" class="form-control text-lg bg-glass pl-4" value="<%= currentOrder.paymentMethod %>" readonly>
                      </div>
          
                      <div class="form-group">
                          <label class="form-label text-lg">Total Amount</label>
                          <input type="text" class="form-control text-lg text-bold bg-glass pl-4" value="Rs: <%= currentOrder.totalAmount %>" readonly>
                      </div>
          
                      <div class="form-group">
                          <label class="form-label text-lg">Track ID</label>
                          <input type="text" class="form-control text-lg text-bold bg-glass pl-4" value="<%= currentOrder.trackId %>" readonly>

                      </div>
                  </div>

              </div>

          </div>


<div class="tab-pane">
  <br>
  
<h3 class="mb-5">Product Details</h3>

<% for(let i=0;i< currentOrder.products.length ;i++ ){  %>
          <div class="form-group mt-5">
            <img src="<%= currentOrder.products[i].productId.image.path1 %>" style="height: 200px; width: 200px;">
            <input type="text" class="form-control text-lg text-bold bg-glass pl-4 mt-2 addressCell" value="<%= currentOrder.products[i].productId.productName %>" style= "width: 400px;" readonly>
            
            
        </div>

        <div class="form-group mb-5">
            <label class="form-label text-lg">Quantity</label>
            <input type="text" class="form-control text-lg text-bold bg-glass pl-4 addressCell" value="Quantity: <%= currentOrder.products[i].quantity %>" style= "width: 400px;" readonly>
        </div>
          
    <%  }  %>
          
</div>






              <!-- Submit Button -->
              <!-- <button type="submit" class="btn btn-primary">Add Category</button> -->
              <% if(typeof smessage !=='undefined' ){ %>
                <div class="alert alert-success text-center text-white text-lg" role="alert">
                  <%= smessage %>
                </div>
                <% } %>
            
                <% if(typeof fmessage !=='undefined' ){ %>
                  <div class="alert alert-danger text-center text-white text-lg" role="alert">
                   <%= fmessage %> 
                  </div>
                  <% } %>
          </form>
        </div>


        <script>
          // constants
        const orderStatusElem = document.getElementById('orderStatus')
        const changeStatusBtn = document.getElementById('changeStatusBtn')
        const orderIdElem = document.getElementById('orderId')
        const CancelOrderBtn = document.getElementById('CancelOrder')
        const cancelledInput = document.getElementById('cancelledInput')
        

        changeStatusBtn.addEventListener('click',changeStatusFn)
        CancelOrderBtn.addEventListener('click',CancelOrderFn)

        // function

        async function changeStatusFn(){
          try {
            const status = orderStatusElem.value
            const orderId = orderIdElem.value

            const response = await fetch(`/admin/changeOrderStatus`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status, orderId }),
                })
                const data = await response.json();
                if(data.message){
                  Swal.fire("Order status changed to "+status);
                }
                console.log(data.message);
          } catch (error) {
            console.log("Could not change Order status");
          }
        }


       async function CancelOrderFn(){
        try {
            const orderId = orderIdElem.value

            Swal.fire({
          title: "Are you sure you want to cancel this order?",
          text: "You won't be able to revert this!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Yes, Cancel Order !"
        }).then(async (result) => {
          if (result.isConfirmed) {

            const response = await fetch(`/admin/cancelOrder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ orderId }),
                })
                const data = await response.json();
                console.log(data.message);
                if(data.message){
                    Swal.fire({
              title: "Order Cancelled!",
              text: "Your order has been cancelled.",
              icon: "success"
            });
            orderStatusElem.value = "Cancelled"
            orderStatusElem.style.display = 'none'
            cancelledInput.style.display = 'block'
            CancelOrderBtn.style.display = 'none'
            changeStatusBtn.style.display = 'none'

                }

          }
        });

     
        } catch (error) {
          console.log("Could not Cancel Order");
        }
      

        }

        </script>


<%- include('../layouts/footer.ejs')%>