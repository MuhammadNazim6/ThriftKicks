<%- include('../layouts/header.ejs')%>

  <div class="mt-n3">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur"
      data-scroll="true">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Pages</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="page"><a class="text-dark"
                href="/admin/products">Orders</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="addProduct">Manage-Orders</li>
          </ol>
        </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">

          </div>
          <ul class="navbar-nav  justify-content-end">

            <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                </div>
              </a>
            </li>
            <li class="nav-item px-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0">
                <i class="fa fa-cog fixed-plugin-button-nav cursor-pointer"></i>
              </a>
            </li>
            <li class="nav-item dropdown pe-2 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="dropdownMenuButton" data-bs-toggle="dropdown"
                aria-expanded="false">
                <i class="fa fa-bell cursor-pointer"></i>
              </a>
              <ul class="dropdown-menu  dropdown-menu-end  px-2 py-3 me-sm-n4" aria-labelledby="dropdownMenuButton">



              </ul>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a href="../pages/sign-in.html" class="nav-link text-body font-weight-bold px-0">
                <i class="fa fa-user me-sm-1"></i>
                <span class="d-sm-inline d-none">Sign In</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- End Navbar -->
  </div>


  <div class="container-fluid py-4">
    <div class="row">
      <div class="col-12">
        <div class="card my-4">
          <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
            <div class="bg-gradient-secondary shadow-dark border-radius-lg pt-4 pb-3">
              <h5 class="text-white text-capitalize ps-3">Manage-Orders</h5>
            </div>
          </div>


          <div class="container mt-5">
            <form action="" method="post">


              <div class="tab-pane">
                <div class="card-body pb-2" style="display: flex;">

                  <div class="left-side" style="flex: 1;">
                    <div class="form-group">
                      <label class="form-label text-lg">Order Id</label>
                      <input type="text" id="orderId" class="form-control text-lg bg-glass text-bold pl-4"
                        value="<%= currentOrder._id %>" style="width: 380px;" readonly>
                    </div>

                    <div class="form-group">
                      <label class="form-label text-lg">Order Status</label>

                      <% if(currentOrder.OrderStatus !=="Cancelled" ){ %>

                        <select class="form-control text-lg bg-glass pl-4" id="orderStatus" style="width: 380px;"
                          value="<%= currentOrder.OrderStatus %>">
                          <option value="<%= currentOrder.OrderStatus %>">
                            <%= currentOrder.OrderStatus %>
                          </option>
                          <option value="Pending"
                            style="<%= currentOrder.OrderStatus === 'Pending' ? 'display:none;' : '' %>">Pending
                          </option>
                          <option value="Shipped"
                            style="<%= currentOrder.OrderStatus === 'Shipped' ? 'display:none;' : '' %>">Shipped
                          </option>
                          <option value="Out for Delivery"
                            style="<%= currentOrder.OrderStatus === 'Out for Delivery' ? 'display:none;' : '' %>">Out
                            for Delivery</option>
                          <option value="Delivered"
                            style="<%= currentOrder.OrderStatus === 'Delivered' ? 'display:none;' : '' %>">Delivered
                          </option>
                        </select>
                        <% }else{ %>
                          <input id="cancelledInput" type="text" class="form-control text-lg bg-danger pl-4 text-white"
                            value="Cancelled" style="width:140px" readonly>
                          <% } %>

                            <input id="cancelledInput" type="text"
                              class="form-control text-lg bg-danger pl-4 text-white" value="Cancelled"
                              style="display:none; width:140px" readonly>
                    </div>
                    <% if(currentOrder.OrderStatus !=="Cancelled" ){ %>
                      <button class="btn btn-dark mt-2" id="changeStatusBtn" type="button"> Change Status</button>
                      <button class="btn btn-danger mt-2 ml-4" id="CancelOrder" type="button"> Cancel Order</button>
                      <% } %>
                  </div>


                  <div class="center" style="flex: 1;">
                    <div class="form-group" style="width: 380px;">
                      <label class="form-label text-lg">Shipping Address</label>
                      <input type="text" class="form-control text-lg bg-glass pl-4 addressCell"
                        value="<%= currentOrder.shippingAddress.fullName %>" readonly>
                      <input type="text" class="form-control text-lg bg-glass pl-4 addressCell"
                        value="<%= currentOrder.shippingAddress.mobile %>" readonly>
                      <input type="text" class="form-control text-lg bg-glass pl-4 addressCell"
                        value="<%= currentOrder.shippingAddress.city %>" readonly>
                      <input type="text" class="form-control text-lg bg-glass pl-4 addressCell"
                        value="<%= currentOrder.shippingAddress.pincode %>" readonly>
                      <input type="text" class="form-control text-lg bg-glass pl-4 addressCell"
                        value="<%= currentOrder.shippingAddress.state %>" readonly>
                      <input type="text" class="form-control text-lg bg-glass pl-4 addressCell"
                        value="<%= currentOrder.shippingAddress.country %>" readonly>
                    </div>
                  </div>


                  <div class="right-side" style="flex: 1;">
                    <div class="form-group">
                      <label class="form-label text-lg">Order Date</label>
                      <input type="text" class="form-control text-lg bg-glass pl-4"
                        value="<%= currentOrder.orderDate.toLocaleDateString() %>" readonly>
                    </div>



                    <div class="form-group">
                      <label class="form-label text-lg">Payment Method</label>
                      <input type="text" class="form-control text-lg bg-glass pl-4"
                        value="<%= currentOrder.paymentMethod %>" readonly>
                    </div>

                    <div class="form-group">
                      <label class="form-label text-lg">Total Amount</label>
                      <input type="text" class="form-control text-lg text-bold bg-glass pl-4"
                        value="Rs: <%= currentOrder.totalAmount %>" readonly>
                    </div>

                    <div class="form-group">
                      <label class="form-label text-lg">Track ID</label>
                      <input type="text" class="form-control text-lg text-bold bg-glass pl-4"
                        value="<%= currentOrder.trackId %>" readonly>
                    </div>
                  </div>
                </div>
              </div>


              <div class="tab-pane">
                <br>

                <h3 class="mb-5 LSpacing">Product Details</h3>

              </div>

          </div>

          <div class="container">
            <div class="row">
              <div class="col-12">

                <table class="table ">
                  <thead>
                    <tr>
                      <th scope="col">#</th>
                      <th scope="col">Product</th>
                      <th scope="col">Name</th>
                      <th scope="col">Quantity</th>
                      <th scope="col">Product Status</th>
                    </tr>
                  </thead>

                  <tbody class="table-group-divider">
                    <% currentOrder.products.forEach(function(product , index) { %>
                      <tr>
                        <td class="p-4" scope="row">
                          <%= index+1 %>
                        </td>
                        <td class="p-4">
                          <img src="<%= product.productId.image.path1 %>" style="height: 200px; width: 200px;">
                        </td>
                        <td class="p-4">
                          <%= product.productId.productName %>
                        </td>
                        <td class="p-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<%= product.quantity %>
                        </td>
                        <!-- <td><%= currentOrder.orderDate.toString().slice(0,15) %></td> -->
                        <td class="p-4">
                          <% if(product.ProductOrderStatus !=="Cancelled" ){ %>
                            <select class="form-control text-lg bg-glass pl-4 ProductOrderStatus"
                              value="<%= product.ProductOrderStatus %>">
                              <option value="<%= product.ProductOrderStatus %>">
                                <%= product.ProductOrderStatus %>
                              </option>
                              <option value="Ordered"
                                style="<%= product.ProductOrderStatus === 'Ordered' ? 'display:none;' : '' %>">Ordered
                              </option>
                              <option value="Shipped"
                                style="<%= product.ProductOrderStatus === 'Shipped' ? 'display:none;' : '' %>">Shipped
                              </option>
                              <option value="Out for Delivery"
                                style="<%= product.ProductOrderStatus === 'Out for Delivery' ? 'display:none;' : '' %>">
                                Out for Delivery</option>
                              <option value="Delivered"
                                style="<%= product.ProductOrderStatus === 'Delivered' ? 'display:none;' : '' %>">
                                Delivered</option>
                              <option value="Returned"
                                style="<%= product.ProductOrderStatus === 'Returned' ? 'display:none;' : '' %>">Returned
                              </option>
                            </select>
                            <% if(product.ProductOrderStatus !=="Cancelled" ){ %>
                              <button class="btn-dark mt-4 changeProdStatusBtn" type="button" data-productId="<%= product.productId._id %>">Change Status</button>
                              <button class="btn-danger mt-4 ml-4 cancelProductBtn" data-productId="<%= product.productId._id %>"  type="button">Cancel
                                Product</button>
                              <% } %>
                                <% } else { %>
                                  <input id="ProductCancelled" type="text"
                                    class="form-control text-lg bg-danger pl-4 mt-4 text-white" value="Product Order Cancelled" style="width: 300px;" readonly>
                                  <% } %>
                                  <input type="text"
                                    class="form-control text-lg bg-danger pl-4 mt-4 text-white ProductCancelled" value="Product Order Cancelled" style="width: 300px; display: none;" readonly>

                        </td>
                      </tr>
                      <% }) %>

                  </tbody>
                </table>

              </div>
            </div>
          </div>






          <% if(typeof smessage !=='undefined' ){ %>
            <div class="alert alert-success text-center text-white text-lg" role="alert">
              <%= smessage %>
            </div>
            <% } %>

              <% if(typeof fmessage !=='undefined' ){ %>
                <div class="alert alert-danger text-center text-white text-lg" role="alert">
                  <%= fmessage %>
                </div>
                <% } %>
                  </form>
        </div>


        <script>
          // constants
          const orderStatusElem = document.getElementById('orderStatus')
          const changeStatusBtn = document.getElementById('changeStatusBtn')
          const orderIdElem = document.getElementById('orderId')
          const CancelOrderBtn = document.getElementById('CancelOrder')
          const cancelledInput = document.getElementById('cancelledInput')


          changeStatusBtn.addEventListener('click', changeStatusFn)
          CancelOrderBtn.addEventListener('click', CancelOrderFn)

          // function

          async function changeStatusFn() {
            try {
              const status = orderStatusElem.value
              const orderId = orderIdElem.value

              const response = await fetch(`/admin/changeOrderStatus`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status, orderId }),
              })
              const data = await response.json();
              if (data.message) {
                Swal.fire({
                  text: "Order status changed to " + status,
                });
              }
              location.reload()
              console.log(data.message);
            } catch (error) {
              console.log("Could not change Order status");
            }
          }


          async function CancelOrderFn() {
            try {
              const orderId = orderIdElem.value

              Swal.fire({
                title: "Are you sure you want to cancel this order?",
                text: "You won't be able to revert this!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, Cancel Order !"
              }).then(async (result) => {
                if (result.isConfirmed) {

                  const response = await fetch(`/admin/cancelOrder`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ orderId }),
                  })
                  const data = await response.json();
                  console.log(data.message);
                  if (data.message) {
                    Swal.fire({
                      title: "Order Cancelled!",
                      text: "Your order has been cancelled.",
                      icon: "success"
                    });
                    orderStatusElem.value = "Cancelled"
                    orderStatusElem.style.display = 'none'
                    cancelledInput.style.display = 'block'
                    CancelOrderBtn.style.display = 'none'
                    changeStatusBtn.style.display = 'none'
                  }
                }
              });


            } catch (error) {
              console.log("Could not Cancel Order");
            }
          }


          //Product Order ststus change
          const ProductOrderStatus = document.querySelectorAll('.ProductOrderStatus')
          const changeProdStatusBtn = document.querySelectorAll('.changeProdStatusBtn')

          //events
     
          changeProdStatusBtn.forEach(function (statBtn) {
            statBtn.addEventListener('click', changeProdStatusFn );
          });


          async function changeProdStatusFn(){
            try {
              
              const status = this.parentNode.querySelector('.ProductOrderStatus').value
              const productId = this.getAttribute('data-productId')
              const orderId = document.getElementById('orderId').value
            
              const response = await fetch('/admin/orders/changeProdStatus',{
              method: 'PATCH',
              headers: {
                'Content-Type' : 'application/json'

              },
              body : JSON.stringify({productId , status , orderId}),
            })
            const data = await response.json();
            if(data.message){
              Swal.fire({
                      title: "Status Change",
                      text: data.message,
                      icon: "success"
                    });
            }

            } catch (error) {
              console.log("Couldn't change product order status");
            }
          }


          //cancel product order in order
          const cancelProductBtn = document.querySelectorAll('.cancelProductBtn')

          cancelProductBtn.forEach((cancelBtn)=>{
            cancelBtn.addEventListener('click',cancelProductFn)
          })

          async function cancelProductFn(){
            try {

              const productId = this.getAttribute('data-productId')
              const orderId = document.getElementById('orderId').value

              Swal.fire({
              title: "Order Cancel",
              text: "Are you sure to cancel this product order?",
              icon: "warning",
              cancelButtonText: 'No',
              showCancelButton: 'true',
              confirmButtonColor: "#3085d6",
              cancelButtonColor: "#d33",
              confirmButtonText: "Yes, cancel it!"
            }).then(async(result) => {
              if (result.isConfirmed) {

                const response = await fetch('/admin/orders/cancelProdOrder',{
              method: 'PATCH',
              headers: {
                'Content-Type' : 'application/json'

              },
              body : JSON.stringify({productId , orderId}),
            })
                
            const data = await response.json();
            if(data.message){
              this.style.display="none"
              this.parentNode.querySelector('.changeProdStatusBtn').style.display = 'none'
              this.parentNode.querySelector('.ProductOrderStatus').style.display = 'none'
              this.parentNode.querySelector('.ProductCancelled').style.display = "inline"

              Swal.fire({
                      text: data.message,
                      icon: "success"
                    });
            }
            
              }
            });
              
            
            } catch (error) {
              console.log("Couldn't cancel product order");
            }
          }
        </script>


        <%- include('../layouts/footer.ejs')%>