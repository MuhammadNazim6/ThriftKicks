<%- include('../layouts/header.ejs')%>
  <style>
    /* Assuming .bg-glass class has some custom styling */
    .bg-glass {
      background-color: rgba(255, 255, 255, 0.2);
      /* Example background color with opacity */
      /* Add any other styles you want for the bg-glass class */
    }

    /* Bootstrap classes for form-control-file */
    .form-control-file {
      display: block;
      width: 100%;
      height: calc(1.5em + 0.75rem + 2px);
      padding: 0.375rem 0.75rem;
      font-size: 1rem;
      line-height: 1.5;
      color: #495057;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
  </style>


  <body class="g-sidenav-show bg-gray-200 ">
    <!-- aside -->
    <aside
      class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3   bg-gradient-dark"
      id="sidenav-main">
      <div class="sidenav-header">
        <i class="fas fa-times p-3 cursor-pointer text-white opacity-5 position-absolute end-0 top-0 d-none d-xl-none"
          aria-hidden="true" id="iconSidenav"></i>
        <a class="navbar-brand m-0" target="_blank">
          <img src="/img/logo-ct.png" class="navbar-brand-img h-100" alt="main_logo">
          <span class="ms-1 font-weight-bold text-white">Thrift Kicks</span>
        </a>
      </div>
      <hr class="horizontal light mt-0 mb-2">
      <div class="collapse navbar-collapse  w-auto " id="sidenav-collapse-main">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link text-white " href="/admin/dashboard">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="fa-solid fa-store"></i>
              </div>
              <span class="nav-link-text ms-1">Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white " href="/admin/users">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="fa fa-users" aria-hidden="true"></i>
              </div>
              <span class="nav-link-text ms-1">Users</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white " href="/admin/orders">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="material-icons opacity-10">receipt_long</i>
              </div>
              <span class="nav-link-text ms-1">Orders</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="/admin/products">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="material-icons opacity-10">view_in_ar</i>
              </div>
              <span class="nav-link-text ms-1">Products</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="/admin/categories">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="fa-solid fa-list"></i>
              </div>
              <span class="nav-link-text ms-1">Categories</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="/admin/coupons">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="fa-solid fa-ticket"></i>
              </div>
              <span class="nav-link-text ms-1">Coupons</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white" href="/admin/banners">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="fa-solid fa-newspaper"></i>
              </div>
              <span class="nav-link-text ms-1">Banners</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white active bg-gradient-secondary" href="/admin/offers">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="fa-solid fa-percent"></i>
              </div>
              <span class="nav-link-text ms-1">Offers</span>
            </a>
          </li>
          <li class="nav-item mt-3">
            <h6 class="ps-4 ms-2 text-uppercase text-xs text-white font-weight-bolder opacity-8">Account pages</h6>
          </li>
          <li class="nav-item">
            <a class="nav-link text-white " href="../pages/profile.html">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="material-icons opacity-10">person</i>
              </div>
              <span class="nav-link-text ms-1">Profile</span>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link text-white " href="/admin/logout">
              <div class="text-white text-center me-2 d-flex align-items-center justify-content-center">
                <i class="material-icons opacity-10">assignment</i>
              </div>
              <span class="nav-link-text ms-1">Logout</span>
            </a>
          </li>
        </ul>
      </div>

    </aside>
    <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">
      <div class="mt-n3">
        <!-- Navbar -->
        <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur"
          data-scroll="true">
          <div class="container-fluid py-1 px-3">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
                <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Pages</a></li>
                <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Offers</li>
              </ol>
              <h6 class="font-weight-bolder mb-0">Offers</h6>
            </nav>
            <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
              <div class="ms-md-auto pe-md-3 d-flex align-items-center">

              </div>
              <ul class="navbar-nav  justify-content-end">

                <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
                  <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
                    <div class="sidenav-toggler-inner">
                      <i class="sidenav-toggler-line"></i>
                      <i class="sidenav-toggler-line"></i>
                      <i class="sidenav-toggler-line"></i>
                    </div>
                  </a>
                </li>
                <li class="nav-item px-3 d-flex align-items-center">
                  <a href="javascript:;" class="nav-link text-body p-0">
                    <i class="fa fa-cog fixed-plugin-button-nav cursor-pointer"></i>
                  </a>
                </li>
                <li class="nav-item dropdown pe-2 d-flex align-items-center">
                  <a href="javascript:;" class="nav-link text-body p-0" id="dropdownMenuButton"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa fa-bell cursor-pointer"></i>
                  </a>
                  <ul class="dropdown-menu  dropdown-menu-end  px-2 py-3 me-sm-n4" aria-labelledby="dropdownMenuButton">
                  </ul>
                </li>
                <li class="nav-item d-flex align-items-center">
                  <a href="../pages/sign-in.html" class="nav-link text-body font-weight-bold px-0">
                    <i class="fa fa-user me-sm-1"></i>
                    <span class="d-sm-inline d-none">Sign In</span>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </nav>
        <!-- End Navbar -->
      </div>
      <div class="container-fluid py-4">
        <div class="row">
          <div class="col-12">
            <div class=" my-4">
              <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                <div class="bg-gradient-secondary shadow-dark border-radius-lg pt-4 pb-3">
                  <h6 class="text-white text-capitalize ps-3">Offers</h6>
                </div>

                <button id="addOfferBtn" class="btn btn-outline-info btn-lg my-4">Add New
                  offer</button>

              </div>

              <div class="border-radius-xl mx-2 mx-md-3 position-relative"
                style="background-image: url('..asssets/img/bg-pricing.jpg'); background-size: cover;">
              </div>

              <div class="container">
                <div class="row">
                  <div class="col-12">


                    <table id="offertable" class="table table-striped">
                      <thead class="thead-light">
                        <tr>
                          <th class="p-4 text-bold text-lg" scope="col">Offer Name</th>
                          <th class="p-4 text-bold text-lg" scope="col">Offer discount %</th>
                          <th class="p-4 text-bold text-lg" scope="col">Expiry date</th>
                          <th class="p-4 text-bold text-lg" scope="col">Status</th>
                          <!-- <th scope="col">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Status</th> -->
                        </tr>
                      </thead>
                      <tbody>
                        <% offers.forEach((offer)=>{   %>
                          <tr>
                          <td class="p-4 text-bold text-lg"> <%= offer.offerName %> </td>
                          <td class="p-4 text-bold text-lg"> <%= offer.offerDiscount %> </td>
                          <td class="p-4 text-bold text-lg"> <%= offer.expiryDate.toLocaleDateString() %> </td>

                          <td class="p-4 text-bold text-lg <%= new Date(offer.expiryDate) > Date.now() ? 'text-success' : 'text-danger' %>"> <%= new Date(offer.expiryDate) > Date.now() ? 'Active' : 'Expired' %> </td>
                        </tr>
                        <%  })   %>
                        
                      </tbody>
                    </table>

                  </div>
                </div>
              </div>

              <script>

                const addOfferBtn = document.getElementById('addOfferBtn')
                addOfferBtn.addEventListener('click', addOffer)

                async function addOffer() {
                  try {
                    const { value: formValues } = await Swal.fire({
                      title: "",
                      html: `
            <h4 class="mt-4" > Add new offer </h4>
            <label for="offerName" class="text-md mt-4" > Offer Name </label>
              <input id="offerName" class="txt-ind mb-3 " style="height:40px; width:400px;">
              <p id="offerNameAlert" class="text-danger" style="display:none;"> Enter a valid name </p>

            <label for="offerDiscount" class="text-md mt-2" > Discount </label>
              <input type='number' id="offerDiscount" class="txt-ind" style="height:40px; width:400px;">

            <label for="expiry" class="text-md mt-2" > Expiry date </label>
              <input type="date" id="expiry" class="txt-ind" style="height:40px; width:400px;">
            `,
                      focusConfirm: false,

                      preConfirm: () => {
                        const offerName = document.getElementById("offerName").value
                        const offerDiscount = document.getElementById("offerDiscount").value
                        const expiry = document.getElementById("expiry").value

                        return [
                          offerName,
                          offerDiscount,
                          expiry
                        ];
                      }
                    });
                    if (formValues) {
                      const response = await fetch('/admin/add-offer', {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ formValues })
                      })

                      const data = await response.json()


                      //if entered name is not proper
                      if (data) {

                        if (data.errMsg) {
                          const Toast = Swal.mixin({
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true,
                            didOpen: (toast) => {
                              toast.onmouseenter = Swal.stopTimer;
                              toast.onmouseleave = Swal.resumeTimer;
                            }
                          });
                          Toast.fire({
                            icon: "error",
                            text: data.errMsg
                          });
                        }
                      }


                      if (data.message) {

                        const Toast = Swal.mixin({
                          toast: true,
                          position: "top-end",
                          showConfirmButton: false,
                          timer: 3000,
                          timerProgressBar: true,
                          didOpen: (toast) => {
                            toast.onmouseenter = Swal.stopTimer;
                            toast.onmouseleave = Swal.resumeTimer;
                          }
                        });
                        Toast.fire({
                          icon: "success",
                          text: data.message
                        });

                        const table = document.getElementById('offertable')
                        const row = table.insertRow(1)

                        const nameRow = row.insertCell(0)
                        const discountRow = row.insertCell(1)
                        const statusRow = row.insertCell(2)

                        nameRow.textContent = formValues[0]
                        nameRow.classList.add('p-4','text-bold' ,'text-lg')

                        discountRow.textContent = formValues[1]
                        discountRow.classList.add('p-4','text-bold' ,'text-lg')

                        statusRow.classList.add('text-success','p-4','text-bold' ,'text-lg')
                        statusRow.textContent = 'Active'
                        
                      }


                    }

                  } catch (error) {
                    console.log("Unable to add offer");
                  }
                }
              </script>

              <%- include('../layouts/footer.ejs')%>